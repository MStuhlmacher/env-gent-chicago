#Michelle Stuhlmacher

#Appendix code

#(A) NDVI threshold testing:
#1. Import data and libraries
#2. Format the data
#3. Plot % greenspace for each threshold by year (formal vs. informal)
#4. Calculate the smoothness of the trends

# STEP 1 -----------------------------------------------
#Import data and libraries

#Import libraries
library(dplyr)
library(ggplot2)
library(gridExtra)
library(scales)
library(tidyr)
library(raster)

#Set working directory
setwd("C:/Users/mstuhlm1/OneDrive - DePaul University/Research/EnvGentrification/Data") #work laptop

#Import land use and greespace files
#70th
g1990_70th = read.csv('./Greenspace/LU1990_NDVI70thPer_L5_20210524.csv')
g2000_70th = read.csv('./Greenspace/LU2001_NDVI70thPer_L5_20210524.csv')
g2010_70th = read.csv('./Greenspace/LU2010_NDVI70thPer_L5_20210524.csv')
g2015_70th = read.csv('./Greenspace/LU2015_NDVI70thPer_L8_20210524.csv')

#75th
g1990_75th = read.csv('./Greenspace/LU1990_NDVI75thPer_L5_20210524.csv')
g2000_75th = read.csv('./Greenspace/LU2001_NDVI75thPer_L5_20210524.csv')
g2010_75th = read.csv('./Greenspace/LU2010_NDVI75thPer_L5_20210524.csv')
g2015_75th = read.csv('./Greenspace/LU2015_NDVI75thPer_L8_20210524.csv')

#80th
g1990_80th = read.csv('./Greenspace/LU1990_NDVI80thPer_L5_20210524.csv')
g2000_80th = read.csv('./Greenspace/LU2001_NDVI80thPer_L5_20210524.csv')
g2010_80th = read.csv('./Greenspace/LU2010_NDVI80thPer_L5_20210524.csv')
g2015_80th = read.csv('./Greenspace/LU2015_NDVI80thPer_L8_20210524.csv')

#85th
g1990_85th = read.csv('./Greenspace/LU1990_NDVI85thPer_L5_20210524.csv')
g2000_85th = read.csv('./Greenspace/LU2001_NDVI85thPer_L5_20210524.csv')
g2010_85th = read.csv('./Greenspace/LU2010_NDVI85thPer_L5_20210524.csv')
g2015_85th = read.csv('./Greenspace/LU2015_NDVI85thPer_L8_20210524.csv')

#90th
g1990_90th = read.csv('./Greenspace/LU1990_NDVI90thPer_L5_20210524.csv')
g2000_90th = read.csv('./Greenspace/LU2001_NDVI90thPer_L5_20210524.csv')
g2010_90th = read.csv('./Greenspace/LU2010_NDVI90thPer_L5_20210524.csv')
g2015_90th = read.csv('./Greenspace/LU2015_NDVI90thPer_L8_20210524.csv')

#Import megatract
MT = shapefile('./RawCensusData/Megatracts/megatract_output_20210408.shp')

# STEP 2 -----------------------------------------------
#Format input data

#Calculate the area of each census tract
#raster area function: area if each spatial object in squared meters if the CRS is longitude/latitude, or in squared map units (typically meter)
proj4string(MT)
#Our map units are m --> proj4string(tract)
MT$areaSqM = area(MT)
chicagoSqM = sum(MT@data$areaSqM)

#Make cluster_id a number
MT@data$cluster_id = as.numeric(MT@data$cluster_id)

# Separate the megatract out by year
#(extents should match for all years so using the same year for all, this only works becuase I'm not using the census data)
MT_1990 = subset(MT, YEAR == "1990")
MT_2000 = subset(MT, YEAR == "1990")
MT_2010 = subset(MT, YEAR == "1990")
MT_2015 = subset(MT, YEAR == "1990")

#rename LANDUSE so it matches for recoding
#70th
names(g1990_70th) = sub("LANDUSE*", "", names(g1990_70th))
names(g2000_70th) = sub("LANDUSE_n*", "", names(g2000_70th))
names(g2010_70th) = sub("LANDUSE_n*", "", names(g2010_70th))
names(g2015_70th) = sub("LANDUSE_n*", "", names(g2015_70th))

#75th
names(g1990_75th) = sub("LANDUSE*", "", names(g1990_75th))
names(g2000_75th) = sub("LANDUSE_n*", "", names(g2000_75th))
names(g2010_75th) = sub("LANDUSE_n*", "", names(g2010_75th))
names(g2015_75th) = sub("LANDUSE_n*", "", names(g2015_75th))

#80th
names(g1990_80th) = sub("LANDUSE*", "", names(g1990_80th))
names(g2000_80th) = sub("LANDUSE_n*", "", names(g2000_80th))
names(g2010_80th) = sub("LANDUSE_n*", "", names(g2010_80th))
names(g2015_80th) = sub("LANDUSE_n*", "", names(g2015_80th))

#85th
names(g1990_85th) = sub("LANDUSE*", "", names(g1990_85th))
names(g2000_85th) = sub("LANDUSE_n*", "", names(g2000_85th))
names(g2010_85th) = sub("LANDUSE_n*", "", names(g2010_85th))
names(g2015_85th) = sub("LANDUSE_n*", "", names(g2015_85th))

#90th
names(g1990_90th) = sub("LANDUSE*", "", names(g1990_90th))
names(g2000_90th) = sub("LANDUSE_n*", "", names(g2000_90th))
names(g2010_90th) = sub("LANDUSE_n*", "", names(g2010_90th))
names(g2015_90th) = sub("LANDUSE_n*", "", names(g2015_90th))

#change to long format for recode
##1990 LANDUSE
#70th
g1990_70th_l = reshape(data = g1990_70th,
                       varying = c("1110","1120","1130","1140","1210","1220","1230",
                                   "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                   "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                   "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                   "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                   "5100","5200","5300","9999"),
                       times = c("1110","1120","1130","1140","1210","1220","1230",
                                 "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                 "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                 "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                 "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                 "5100","5200","5300","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#75th
g1990_75th_l = reshape(data = g1990_75th,
                       varying = c("1110","1120","1130","1140","1210","1220","1230",
                                   "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                   "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                   "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                   "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                   "5100","5200","5300","9999"),
                       times = c("1110","1120","1130","1140","1210","1220","1230",
                                 "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                 "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                 "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                 "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                 "5100","5200","5300","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#80th
g1990_80th_l = reshape(data = g1990_80th,
                       varying = c("1110","1120","1130","1140","1210","1220","1230",
                                   "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                   "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                   "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                   "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                   "5100","5200","5300","9999"),
                       times = c("1110","1120","1130","1140","1210","1220","1230",
                                 "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                 "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                 "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                 "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                 "5100","5200","5300","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")
#85th
g1990_85th_l = reshape(data = g1990_85th,
                       varying = c("1110","1120","1130","1140","1210","1220","1230",
                                   "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                   "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                   "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                   "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                   "5100","5200","5300","9999"),
                       times = c("1110","1120","1130","1140","1210","1220","1230",
                                 "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                 "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                 "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                 "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                 "5100","5200","5300","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#90th
g1990_90th_l = reshape(data = g1990_90th,
                       varying = c("1110","1120","1130","1140","1210","1220","1230",
                                   "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                   "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                   "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                   "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                   "5100","5200","5300","9999"),
                       times = c("1110","1120","1130","1140","1210","1220","1230",
                                 "1241","1242","1243","1250","1260","1311","1312","1313","1320",
                                 "1330","1340","1360","1370","1380","1390","1410","1420","1430",
                                 "1440","1510","1520","1530","1540","1550","1560","2000","3110",
                                 "3120","3130","3210","3220","4110","4120","4210","4220","4300",
                                 "5100","5200","5300","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

##2000 LANDUSE
#70th
g2000_70th_l = reshape(data = g2000_70th,
                       varying = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                   "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                   "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                   "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       times = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                 "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                 "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                 "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#75th
g2000_75th_l = reshape(data = g2000_75th,
                       varying = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                   "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                   "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                   "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       times = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                 "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                 "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                 "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#80th
g2000_80th_l = reshape(data = g2000_80th,
                       varying = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                   "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                   "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                   "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       times = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                 "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                 "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                 "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#85th
g2000_85th_l = reshape(data = g2000_85th,
                       varying = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                   "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                   "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                   "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       times = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                 "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                 "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                 "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#90th
g2000_90th_l = reshape(data = g2000_90th,
                       varying = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                   "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                   "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                   "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       times = c("1110","1120","1130","1140","1211","1212","1221","1222","1223","1231","1232","1240",
                                 "1250","1310","1320","1330","1340","1350","1360","1370","1410","1420","1430","1440",
                                 "1511","1512","1520","1530","1540","1550","1560","2100","2200","3100","3200","3300",
                                 "3400","3500","3600","4110","4120","4210","4220","4300","5100","5200","5300"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

##2010 LANDUSE
#70th
g2010_70th_l = reshape(data = g2010_70th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6100","6200","6300","6400","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6100","6200","6300","6400","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#75th
g2010_75th_l = reshape(data = g2010_75th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6100","6200","6300","6400","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6100","6200","6300","6400","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#80th
g2010_80th_l = reshape(data = g2010_80th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6100","6200","6300","6400","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6100","6200","6300","6400","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#85th
g2010_85th_l = reshape(data = g2010_85th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6100","6200","6300","6400","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6100","6200","6300","6400","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#90th
g2010_90th_l = reshape(data = g2010_90th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6100","6200","6300","6400","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6100","6200","6300","6400","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

##2015 LANDUSE
#70th
g2015_70th_l = reshape(data = g2015_70th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6000","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6000","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#75th
g2015_75th_l = reshape(data = g2015_75th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6000","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6000","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#80th
g2015_80th_l = reshape(data = g2015_80th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6000","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6000","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#85th
g2015_85th_l = reshape(data = g2015_85th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6000","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6000","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

#90th
g2015_90th_l = reshape(data = g2015_90th,
                       varying = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                   "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                   "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                   "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                   "4240","5000","6000","9999"),
                       times = c("1111","1112","1130","1140","1151","1211","1212","1214","1215","1216","1220","1240","1250",
                                 "1310","1321","1322","1330","1340","1350","1360","1370","1410","1420","1431","1432","1433",
                                 "1450","1511","1512","1520","1530","1540","1550","1561","1562","1563","1564","1565","1570",
                                 "2000","3100","3200","3300","3400","3500","4110","4120","4130","4140","4210","4220","4230",
                                 "4240","5000","6000","9999"),
                       idvar = "cluster_id",
                       v.names = "SqM",
                       direction = "long")

# Create yearly green space variables: 
#1) park green space, 2) green space on vacant land, 3) all other green space  

#Add columns with LU codes in one column and the string name in another
##1990
#70th
g1990_70th_l$GreenType = ifelse(g1990_70th_l$time == 3110 | g1990_70th_l$time == 3120 | g1990_70th_l$time == 3130 | g1990_70th_l$time == 3210 | g1990_70th_l$time == 3220, 1,
                                ifelse(g1990_70th_l$time == 4300 | g1990_70th_l$time == 4110, 2,
                                       3))

g1990_70th_l$CATEGORY_t = ifelse(g1990_70th_l$GreenType == 1, "Park", 
                                 ifelse(g1990_70th_l$GreenType == 2, "Vacant",
                                        ifelse(g1990_70th_l$GreenType == 3, "Other",
                                               "ERROR")))
#75th
g1990_75th_l$GreenType = ifelse(g1990_75th_l$time == 3110 | g1990_75th_l$time == 3120 | g1990_75th_l$time == 3130 | g1990_75th_l$time == 3210 | g1990_75th_l$time == 3220, 1,
                                ifelse(g1990_75th_l$time == 4300 | g1990_75th_l$time == 4110, 2,
                                       3))

g1990_75th_l$CATEGORY_t = ifelse(g1990_75th_l$GreenType == 1, "Park", 
                                 ifelse(g1990_75th_l$GreenType == 2, "Vacant",
                                        ifelse(g1990_75th_l$GreenType == 3, "Other",
                                               "ERROR")))

#80th
g1990_80th_l$GreenType = ifelse(g1990_80th_l$time == 3110 | g1990_80th_l$time == 3120 | g1990_80th_l$time == 3130 | g1990_80th_l$time == 3210 | g1990_80th_l$time == 3220, 1,
                                ifelse(g1990_80th_l$time == 4300 | g1990_80th_l$time == 4110, 2,
                                       3))

g1990_80th_l$CATEGORY_t = ifelse(g1990_80th_l$GreenType == 1, "Park", 
                                 ifelse(g1990_80th_l$GreenType == 2, "Vacant",
                                        ifelse(g1990_80th_l$GreenType == 3, "Other",
                                               "ERROR")))
#85th
g1990_85th_l$GreenType = ifelse(g1990_85th_l$time == 3110 | g1990_85th_l$time == 3120 | g1990_85th_l$time == 3130 | g1990_85th_l$time == 3210 | g1990_85th_l$time == 3220, 1,
                                ifelse(g1990_85th_l$time == 4300 | g1990_85th_l$time == 4110, 2,
                                       3))

g1990_85th_l$CATEGORY_t = ifelse(g1990_85th_l$GreenType == 1, "Park", 
                                 ifelse(g1990_85th_l$GreenType == 2, "Vacant",
                                        ifelse(g1990_85th_l$GreenType == 3, "Other",
                                               "ERROR")))
#90th
g1990_90th_l$GreenType = ifelse(g1990_90th_l$time == 3110 | g1990_90th_l$time == 3120 | g1990_90th_l$time == 3130 | g1990_90th_l$time == 3210 | g1990_90th_l$time == 3220, 1,
                                ifelse(g1990_90th_l$time == 4300 | g1990_90th_l$time == 4110, 2,
                                       3))

g1990_90th_l$CATEGORY_t = ifelse(g1990_90th_l$GreenType == 1, "Park", 
                                 ifelse(g1990_90th_l$GreenType == 2, "Vacant",
                                        ifelse(g1990_90th_l$GreenType == 3, "Other",
                                               "ERROR")))

##2000
#70th
g2000_70th_l$GreenType = ifelse(g2000_70th_l$time == 3100 | g2000_70th_l$time == 3200 | g2000_70th_l$time == 3300, 1, 
                                ifelse(g2000_70th_l$time == 4300 | g2000_70th_l$time == 4110, 2,
                                       3))

g2000_70th_l$CATEGORY_t = ifelse(g2000_70th_l$GreenType == 1, "Park", 
                                 ifelse(g2000_70th_l$GreenType == 2, "Vacant",
                                        ifelse(g2000_70th_l$GreenType == 3, "Other",
                                               "ERROR")))
#75th
g2000_75th_l$GreenType = ifelse(g2000_75th_l$time == 3100 | g2000_75th_l$time == 3200 | g2000_75th_l$time == 3300, 1, 
                                ifelse(g2000_75th_l$time == 4300 | g2000_75th_l$time == 4110, 2,
                                       3))

g2000_75th_l$CATEGORY_t = ifelse(g2000_75th_l$GreenType == 1, "Park", 
                                 ifelse(g2000_75th_l$GreenType == 2, "Vacant",
                                        ifelse(g2000_75th_l$GreenType == 3, "Other",
                                               "ERROR")))

#80th
g2000_80th_l$GreenType = ifelse(g2000_80th_l$time == 3100 | g2000_80th_l$time == 3200 | g2000_80th_l$time == 3300, 1, 
                                ifelse(g2000_80th_l$time == 4300 | g2000_80th_l$time == 4110, 2,
                                       3))

g2000_80th_l$CATEGORY_t = ifelse(g2000_80th_l$GreenType == 1, "Park", 
                                 ifelse(g2000_80th_l$GreenType == 2, "Vacant",
                                        ifelse(g2000_80th_l$GreenType == 3, "Other",
                                               "ERROR")))

#85th
g2000_85th_l$GreenType = ifelse(g2000_85th_l$time == 3100 | g2000_85th_l$time == 3200 | g2000_85th_l$time == 3300, 1, 
                                ifelse(g2000_85th_l$time == 4300 | g2000_85th_l$time == 4110, 2,
                                       3))

g2000_85th_l$CATEGORY_t = ifelse(g2000_85th_l$GreenType == 1, "Park", 
                                 ifelse(g2000_85th_l$GreenType == 2, "Vacant",
                                        ifelse(g2000_85th_l$GreenType == 3, "Other",
                                               "ERROR")))

#90th
g2000_90th_l$GreenType = ifelse(g2000_90th_l$time == 3100 | g2000_90th_l$time == 3200 | g2000_90th_l$time == 3300, 1, 
                                ifelse(g2000_90th_l$time == 4300 | g2000_90th_l$time == 4110, 2,
                                       3))

g2000_90th_l$CATEGORY_t = ifelse(g2000_90th_l$GreenType == 1, "Park", 
                                 ifelse(g2000_90th_l$GreenType == 2, "Vacant",
                                        ifelse(g2000_90th_l$GreenType == 3, "Other",
                                               "ERROR")))

##2010
#70th
g2010_70th_l$GreenType = ifelse(g2010_70th_l$time == 3100 | g2010_70th_l$time == 3200 | g2010_70th_l$time == 3300 | g2010_70th_l$time == 3500, 1, 
                                ifelse(g2010_70th_l$time == 4110 | g2010_70th_l$time == 4120 | g2010_70th_l$time == 4130 | g2010_70th_l$time == 4140, 2, 
                                       3))

g2010_70th_l$CATEGORY_t = ifelse(g2010_70th_l$GreenType == 1, "Park", 
                                 ifelse(g2010_70th_l$GreenType == 2, "Vacant",
                                        ifelse(g2010_70th_l$GreenType == 3, "Other",
                                               "ERROR")))
#75th
g2010_75th_l$GreenType = ifelse(g2010_75th_l$time == 3100 | g2010_75th_l$time == 3200 | g2010_75th_l$time == 3300 | g2010_75th_l$time == 3500, 1, 
                                ifelse(g2010_75th_l$time == 4110 | g2010_75th_l$time == 4120 | g2010_75th_l$time == 4130 | g2010_75th_l$time == 4140, 2, 
                                       3))

g2010_75th_l$CATEGORY_t = ifelse(g2010_75th_l$GreenType == 1, "Park", 
                                 ifelse(g2010_75th_l$GreenType == 2, "Vacant",
                                        ifelse(g2010_75th_l$GreenType == 3, "Other",
                                               "ERROR")))

#80th
g2010_80th_l$GreenType = ifelse(g2010_80th_l$time == 3100 | g2010_80th_l$time == 3200 | g2010_80th_l$time == 3300 | g2010_80th_l$time == 3500, 1, 
                                ifelse(g2010_80th_l$time == 4110 | g2010_80th_l$time == 4120 | g2010_80th_l$time == 4130 | g2010_80th_l$time == 4140, 2, 
                                       3))

g2010_80th_l$CATEGORY_t = ifelse(g2010_80th_l$GreenType == 1, "Park", 
                                 ifelse(g2010_80th_l$GreenType == 2, "Vacant",
                                        ifelse(g2010_80th_l$GreenType == 3, "Other",
                                               "ERROR")))
#85th
g2010_85th_l$GreenType = ifelse(g2010_85th_l$time == 3100 | g2010_85th_l$time == 3200 | g2010_85th_l$time == 3300 | g2010_85th_l$time == 3500, 1, 
                                ifelse(g2010_85th_l$time == 4110 | g2010_85th_l$time == 4120 | g2010_85th_l$time == 4130 | g2010_85th_l$time == 4140, 2, 
                                       3))

g2010_85th_l$CATEGORY_t = ifelse(g2010_85th_l$GreenType == 1, "Park", 
                                 ifelse(g2010_85th_l$GreenType == 2, "Vacant",
                                        ifelse(g2010_85th_l$GreenType == 3, "Other",
                                               "ERROR")))
#90th
g2010_90th_l$GreenType = ifelse(g2010_90th_l$time == 3100 | g2010_90th_l$time == 3200 | g2010_90th_l$time == 3300 | g2010_90th_l$time == 3500, 1, 
                                ifelse(g2010_90th_l$time == 4110 | g2010_90th_l$time == 4120 | g2010_90th_l$time == 4130 | g2010_90th_l$time == 4140, 2, 
                                       3))

g2010_90th_l$CATEGORY_t = ifelse(g2010_90th_l$GreenType == 1, "Park", 
                                 ifelse(g2010_90th_l$GreenType == 2, "Vacant",
                                        ifelse(g2010_90th_l$GreenType == 3, "Other",
                                               "ERROR")))

##2015
#70th
g2015_70th_l$GreenType = ifelse(g2015_70th_l$time == 3100 | g2015_70th_l$time == 3200 | g2015_70th_l$time == 3300 | g2015_70th_l$time == 3500, 1, 
                                ifelse(g2015_70th_l$time == 4110 | g2015_70th_l$time == 4120 | g2015_70th_l$time == 4130 | g2015_70th_l$time == 4140, 2, 
                                       3))

g2015_70th_l$CATEGORY_t = ifelse(g2015_70th_l$GreenType == 1, "Park", 
                                 ifelse(g2015_70th_l$GreenType == 2, "Vacant",
                                        ifelse(g2015_70th_l$GreenType == 3, "Other",
                                               "ERROR")))
#75th
g2015_75th_l$GreenType = ifelse(g2015_75th_l$time == 3100 | g2015_75th_l$time == 3200 | g2015_75th_l$time == 3300 | g2015_75th_l$time == 3500, 1, 
                                ifelse(g2015_75th_l$time == 4110 | g2015_75th_l$time == 4120 | g2015_75th_l$time == 4130 | g2015_75th_l$time == 4140, 2, 
                                       3))

g2015_75th_l$CATEGORY_t = ifelse(g2015_75th_l$GreenType == 1, "Park", 
                                 ifelse(g2015_75th_l$GreenType == 2, "Vacant",
                                        ifelse(g2015_75th_l$GreenType == 3, "Other",
                                               "ERROR")))
#80th
g2015_80th_l$GreenType = ifelse(g2015_80th_l$time == 3100 | g2015_80th_l$time == 3200 | g2015_80th_l$time == 3300 | g2015_80th_l$time == 3500, 1, 
                                ifelse(g2015_80th_l$time == 4110 | g2015_80th_l$time == 4120 | g2015_80th_l$time == 4130 | g2015_80th_l$time == 4140, 2, 
                                       3))

g2015_80th_l$CATEGORY_t = ifelse(g2015_80th_l$GreenType == 1, "Park", 
                                 ifelse(g2015_80th_l$GreenType == 2, "Vacant",
                                        ifelse(g2015_80th_l$GreenType == 3, "Other",
                                               "ERROR")))
#85th
g2015_85th_l$GreenType = ifelse(g2015_85th_l$time == 3100 | g2015_85th_l$time == 3200 | g2015_85th_l$time == 3300 | g2015_85th_l$time == 3500, 1, 
                                ifelse(g2015_85th_l$time == 4110 | g2015_85th_l$time == 4120 | g2015_85th_l$time == 4130 | g2015_85th_l$time == 4140, 2, 
                                       3))

g2015_85th_l$CATEGORY_t = ifelse(g2015_85th_l$GreenType == 1, "Park", 
                                 ifelse(g2015_85th_l$GreenType == 2, "Vacant",
                                        ifelse(g2015_85th_l$GreenType == 3, "Other",
                                               "ERROR")))
#90th
g2015_90th_l$GreenType = ifelse(g2015_90th_l$time == 3100 | g2015_90th_l$time == 3200 | g2015_90th_l$time == 3300 | g2015_90th_l$time == 3500, 1, 
                                ifelse(g2015_90th_l$time == 4110 | g2015_90th_l$time == 4120 | g2015_90th_l$time == 4130 | g2015_90th_l$time == 4140, 2, 
                                       3))

g2015_90th_l$CATEGORY_t = ifelse(g2015_90th_l$GreenType == 1, "Park", 
                                 ifelse(g2015_90th_l$GreenType == 2, "Vacant",
                                        ifelse(g2015_90th_l$GreenType == 3, "Other",
                                               "ERROR")))

#Create greenspace variables
#A. Drop rows with NA and 0 values to speed processing time
##1990
#70th
g1990_70th_l = g1990_70th_l[!is.na(g1990_70th_l$SqM),] 
g1990_70th_l = g1990_70th_l[g1990_70th_l$SqM != 0,]

#75th
g1990_75th_l = g1990_75th_l[!is.na(g1990_75th_l$SqM),] 
g1990_75th_l = g1990_75th_l[g1990_75th_l$SqM != 0,]

#80th
g1990_80th_l = g1990_80th_l[!is.na(g1990_80th_l$SqM),] 
g1990_80th_l = g1990_80th_l[g1990_80th_l$SqM != 0,]

#85th
g1990_85th_l = g1990_85th_l[!is.na(g1990_85th_l$SqM),] 
g1990_85th_l = g1990_85th_l[g1990_85th_l$SqM != 0,]

#90th
g1990_90th_l = g1990_90th_l[!is.na(g1990_90th_l$SqM),] 
g1990_90th_l = g1990_90th_l[g1990_90th_l$SqM != 0,]

##2000
#70th
g2000_70th_l = g2000_70th_l[!is.na(g2000_70th_l$SqM),] 
g2000_70th_l = g2000_70th_l[g2000_70th_l$SqM != 0,]

#75th
g2000_75th_l = g2000_75th_l[!is.na(g2000_75th_l$SqM),] 
g2000_75th_l = g2000_75th_l[g2000_75th_l$SqM != 0,]

#80th
g2000_80th_l = g2000_80th_l[!is.na(g2000_80th_l$SqM),] 
g2000_80th_l = g2000_80th_l[g2000_80th_l$SqM != 0,]

#85th
g2000_85th_l = g2000_85th_l[!is.na(g2000_85th_l$SqM),] 
g2000_85th_l = g2000_85th_l[g2000_85th_l$SqM != 0,]

#90th
g2000_90th_l = g2000_90th_l[!is.na(g2000_90th_l$SqM),] 
g2000_90th_l = g2000_90th_l[g2000_90th_l$SqM != 0,]

##2010
#70th
g2010_70th_l = g2010_70th_l[!is.na(g2010_70th_l$SqM),] 
g2010_70th_l = g2010_70th_l[g2010_70th_l$SqM != 0,]

#75th
g2010_75th_l = g2010_75th_l[!is.na(g2010_75th_l$SqM),] 
g2010_75th_l = g2010_75th_l[g2010_75th_l$SqM != 0,]

#80th
g2010_80th_l = g2010_80th_l[!is.na(g2010_80th_l$SqM),] 
g2010_80th_l = g2010_80th_l[g2010_80th_l$SqM != 0,]

#85th
g2010_85th_l = g2010_85th_l[!is.na(g2010_85th_l$SqM),] 
g2010_85th_l = g2010_85th_l[g2010_85th_l$SqM != 0,]

#90th
g2010_90th_l = g2010_90th_l[!is.na(g2010_90th_l$SqM),] 
g2010_90th_l = g2010_90th_l[g2010_90th_l$SqM != 0,]

##2015
#70th
g2015_70th_l = g2015_70th_l[!is.na(g2015_70th_l$SqM),] 
g2015_70th_l = g2015_70th_l[g2015_70th_l$SqM != 0,]

#75th
g2015_75th_l = g2015_75th_l[!is.na(g2015_75th_l$SqM),] 
g2015_75th_l = g2015_75th_l[g2015_75th_l$SqM != 0,]

#80th
g2015_80th_l = g2015_80th_l[!is.na(g2015_80th_l$SqM),] 
g2015_80th_l = g2015_80th_l[g2015_80th_l$SqM != 0,]

#85th
g2015_85th_l = g2015_85th_l[!is.na(g2015_85th_l$SqM),] 
g2015_85th_l = g2015_85th_l[g2015_85th_l$SqM != 0,]

#90th
g2015_90th_l = g2015_90th_l[!is.na(g2015_90th_l$SqM),] 
g2015_90th_l = g2015_90th_l[g2015_90th_l$SqM != 0,]

#B. Summarize by greenspace type and census tract (a.k.a cluster id)
##1990
#70th
summary1990_NDVI70th = g1990_70th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary1990_NDVI70th) = c("cluster_id","CATEGORY","GreenSqM")

#75th
summary1990_NDVI75th = g1990_75th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary1990_NDVI75th) = c("cluster_id","CATEGORY","GreenSqM")

#80th
summary1990_NDVI80th = g1990_80th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary1990_NDVI80th) = c("cluster_id","CATEGORY","GreenSqM")

#85th
summary1990_NDVI85th = g1990_85th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary1990_NDVI85th) = c("cluster_id","CATEGORY","GreenSqM")

#90th
summary1990_NDVI90th = g1990_90th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary1990_NDVI90th) = c("cluster_id","CATEGORY","GreenSqM")

##2000
#70th
summary2000_NDVI70th = g2000_70th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2000_NDVI70th) = c("cluster_id","CATEGORY","GreenSqM")

#75th
summary2000_NDVI75th = g2000_75th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2000_NDVI75th) = c("cluster_id","CATEGORY","GreenSqM")

#80th
summary2000_NDVI80th = g2000_80th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2000_NDVI80th) = c("cluster_id","CATEGORY","GreenSqM")

#85th
summary2000_NDVI85th = g2000_85th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2000_NDVI85th) = c("cluster_id","CATEGORY","GreenSqM")

#90th
summary2000_NDVI90th = g2000_90th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2000_NDVI90th) = c("cluster_id","CATEGORY","GreenSqM")

##2010
#70th
summary2010_NDVI70th = g2010_70th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2010_NDVI70th) = c("cluster_id","CATEGORY","GreenSqM")

#75th
summary2010_NDVI75th = g2010_75th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2010_NDVI75th) = c("cluster_id","CATEGORY","GreenSqM")

#80th
summary2010_NDVI80th = g2010_80th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2010_NDVI80th) = c("cluster_id","CATEGORY","GreenSqM")

#85th
summary2010_NDVI85th = g2010_85th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2010_NDVI85th) = c("cluster_id","CATEGORY","GreenSqM")

#90th
summary2010_NDVI90th = g2010_90th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2010_NDVI90th) = c("cluster_id","CATEGORY","GreenSqM")

##2015
#70th
summary2015_NDVI70th = g2015_70th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2015_NDVI70th) = c("cluster_id","CATEGORY","GreenSqM")

#75th
summary2015_NDVI75th = g2015_75th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2015_NDVI75th) = c("cluster_id","CATEGORY","GreenSqM")

#80th
summary2015_NDVI80th = g2015_80th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2015_NDVI80th) = c("cluster_id","CATEGORY","GreenSqM")

#85th
summary2015_NDVI85th = g2015_85th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2015_NDVI85th) = c("cluster_id","CATEGORY","GreenSqM")

#90th
summary2015_NDVI90th = g2015_90th_l %>%
  group_by(cluster_id, GreenType) %>%
  summarise(sum = sum(SqM))
colnames(summary2015_NDVI90th) = c("cluster_id","CATEGORY","GreenSqM")

#C. Reshape from long to wide
##1990
#70th
summary1990_NDVI70th_w = pivot_wider(data=summary1990_NDVI70th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#75th
summary1990_NDVI75th_w = pivot_wider(data=summary1990_NDVI75th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#80th
summary1990_NDVI80th_w = pivot_wider(data=summary1990_NDVI80th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#85th
summary1990_NDVI85th_w = pivot_wider(data=summary1990_NDVI85th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#90th
summary1990_NDVI90th_w = pivot_wider(data=summary1990_NDVI90th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
##2000
#70th
summary2000_NDVI70th_w = pivot_wider(data=summary2000_NDVI70th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#75th
summary2000_NDVI75th_w = pivot_wider(data=summary2000_NDVI75th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#80th
summary2000_NDVI80th_w = pivot_wider(data=summary2000_NDVI80th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#85th
summary2000_NDVI85th_w = pivot_wider(data=summary2000_NDVI85th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#90th
summary2000_NDVI90th_w = pivot_wider(data=summary2000_NDVI90th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
##2010
#70th
summary2010_NDVI70th_w = pivot_wider(data=summary2010_NDVI70th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#75th
summary2010_NDVI75th_w = pivot_wider(data=summary2010_NDVI75th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#80th
summary2010_NDVI80th_w = pivot_wider(data=summary2010_NDVI80th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#85th
summary2010_NDVI85th_w = pivot_wider(data=summary2010_NDVI85th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#90th
summary2010_NDVI90th_w = pivot_wider(data=summary2010_NDVI90th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
##2015
#70th
summary2015_NDVI70th_w = pivot_wider(data=summary2015_NDVI70th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#75th
summary2015_NDVI75th_w = pivot_wider(data=summary2015_NDVI75th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#80th
summary2015_NDVI80th_w = pivot_wider(data=summary2015_NDVI80th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#85th
summary2015_NDVI85th_w = pivot_wider(data=summary2015_NDVI85th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")
#90th
summary2015_NDVI90th_w = pivot_wider(data=summary2015_NDVI90th,
                                     id_cols = "cluster_id",
                                     names_from = "CATEGORY",
                                     values_from = "GreenSqM")

#D. Rename
#1 = "Formal",2 = "Informal"
#1) park green space, 2) green space on vacant land, 3) all other green space
oldnames = c('1','2','3')
newnames = c('ParkGreenSqM','VacGreenSqM','OtherGreenSqM')

##1990
#70th
summary1990_NDVI70th_w = summary1990_NDVI70th_w %>% rename_at(vars(oldnames), ~ newnames)
#75th
summary1990_NDVI75th_w = summary1990_NDVI75th_w %>% rename_at(vars(oldnames), ~ newnames)
#80th
summary1990_NDVI80th_w = summary1990_NDVI80th_w %>% rename_at(vars(oldnames), ~ newnames)
#85th
summary1990_NDVI85th_w = summary1990_NDVI85th_w %>% rename_at(vars(oldnames), ~ newnames)
#90th
summary1990_NDVI90th_w = summary1990_NDVI90th_w %>% rename_at(vars(oldnames), ~ newnames)

##2000
#70th
summary2000_NDVI70th_w = summary2000_NDVI70th_w %>% rename_at(vars(oldnames), ~ newnames)
#75th
summary2000_NDVI75th_w = summary2000_NDVI75th_w %>% rename_at(vars(oldnames), ~ newnames)
#80th
summary2000_NDVI80th_w = summary2000_NDVI80th_w %>% rename_at(vars(oldnames), ~ newnames)
#85th
summary2000_NDVI85th_w = summary2000_NDVI85th_w %>% rename_at(vars(oldnames), ~ newnames)
#90th
summary2000_NDVI90th_w = summary2000_NDVI90th_w %>% rename_at(vars(oldnames), ~ newnames)

##2010
#70th
summary2010_NDVI70th_w = summary2010_NDVI70th_w %>% rename_at(vars(oldnames), ~ newnames)
#75th
summary2010_NDVI75th_w = summary2010_NDVI75th_w %>% rename_at(vars(oldnames), ~ newnames)
#80th
summary2010_NDVI80th_w = summary2010_NDVI80th_w %>% rename_at(vars(oldnames), ~ newnames)
#85th
summary2010_NDVI85th_w = summary2010_NDVI85th_w %>% rename_at(vars(oldnames), ~ newnames)
#90th
summary2010_NDVI90th_w = summary2010_NDVI90th_w %>% rename_at(vars(oldnames), ~ newnames)

##2015
#70th
summary2015_NDVI70th_w = summary2015_NDVI70th_w %>% rename_at(vars(oldnames), ~ newnames)
#75th
summary2015_NDVI75th_w = summary2015_NDVI75th_w %>% rename_at(vars(oldnames), ~ newnames)
#80th
summary2015_NDVI80th_w = summary2015_NDVI80th_w %>% rename_at(vars(oldnames), ~ newnames)
#85th
summary2015_NDVI85th_w = summary2015_NDVI85th_w %>% rename_at(vars(oldnames), ~ newnames)
#90th
summary2015_NDVI90th_w = summary2015_NDVI90th_w %>% rename_at(vars(oldnames), ~ newnames)

#E.Replace NAs with 0s (otherwise the sum in step F won't work)
##1990
#70th
summary1990_NDVI70th_w[is.na(summary1990_NDVI70th_w)] = 0 
#75th
summary1990_NDVI75th_w[is.na(summary1990_NDVI75th_w)] = 0 
#80th
summary1990_NDVI80th_w[is.na(summary1990_NDVI80th_w)] = 0 
#85th
summary1990_NDVI85th_w[is.na(summary1990_NDVI85th_w)] = 0 
#90th
summary1990_NDVI90th_w[is.na(summary1990_NDVI90th_w)] = 0 

##2000
#70th
summary2000_NDVI70th_w[is.na(summary2000_NDVI70th_w)] = 0 
#75th
summary2000_NDVI75th_w[is.na(summary2000_NDVI75th_w)] = 0 
#80th
summary2000_NDVI80th_w[is.na(summary2000_NDVI80th_w)] = 0 
#85th
summary2000_NDVI85th_w[is.na(summary2000_NDVI85th_w)] = 0 
#90th
summary2000_NDVI90th_w[is.na(summary2000_NDVI90th_w)] = 0

##2010
#70th
summary2010_NDVI70th_w[is.na(summary2010_NDVI70th_w)] = 0 
#75th
summary2010_NDVI75th_w[is.na(summary2010_NDVI75th_w)] = 0 
#80th
summary2010_NDVI80th_w[is.na(summary2010_NDVI80th_w)] = 0 
#85th
summary2010_NDVI85th_w[is.na(summary2010_NDVI85th_w)] = 0 
#90th
summary2010_NDVI90th_w[is.na(summary2010_NDVI90th_w)] = 0

##2015
#70th
summary2015_NDVI70th_w[is.na(summary2015_NDVI70th_w)] = 0 
#75th
summary2015_NDVI75th_w[is.na(summary2015_NDVI75th_w)] = 0 
#80th
summary2015_NDVI80th_w[is.na(summary2015_NDVI80th_w)] = 0 
#85th
summary2015_NDVI85th_w[is.na(summary2015_NDVI85th_w)] = 0 
#90th
summary2015_NDVI90th_w[is.na(summary2015_NDVI90th_w)] = 0

#F. Add up all the greenspace in each census tract
##1990
#70th
summary1990_NDVI70th_w$GreenSqM = summary1990_NDVI70th_w$ParkGreenSqM + summary1990_NDVI70th_w$VacGreenSqM + summary1990_NDVI70th_w$OtherGreenSqM
#75th
summary1990_NDVI75th_w$GreenSqM = summary1990_NDVI75th_w$ParkGreenSqM + summary1990_NDVI75th_w$VacGreenSqM + summary1990_NDVI75th_w$OtherGreenSqM
#80th
summary1990_NDVI80th_w$GreenSqM = summary1990_NDVI80th_w$ParkGreenSqM + summary1990_NDVI80th_w$VacGreenSqM + summary1990_NDVI80th_w$OtherGreenSqM
#85th
summary1990_NDVI85th_w$GreenSqM = summary1990_NDVI85th_w$ParkGreenSqM + summary1990_NDVI85th_w$VacGreenSqM + summary1990_NDVI85th_w$OtherGreenSqM
#90th
summary1990_NDVI90th_w$GreenSqM = summary1990_NDVI90th_w$ParkGreenSqM + summary1990_NDVI90th_w$VacGreenSqM + summary1990_NDVI90th_w$OtherGreenSqM

##2000
#70th
summary2000_NDVI70th_w$GreenSqM = summary2000_NDVI70th_w$ParkGreenSqM + summary2000_NDVI70th_w$VacGreenSqM + summary2000_NDVI70th_w$OtherGreenSqM
#75th
summary2000_NDVI75th_w$GreenSqM = summary2000_NDVI75th_w$ParkGreenSqM + summary2000_NDVI75th_w$VacGreenSqM + summary2000_NDVI75th_w$OtherGreenSqM
#80th
summary2000_NDVI80th_w$GreenSqM = summary2000_NDVI80th_w$ParkGreenSqM + summary2000_NDVI80th_w$VacGreenSqM + summary2000_NDVI80th_w$OtherGreenSqM
#85th
summary2000_NDVI85th_w$GreenSqM = summary2000_NDVI85th_w$ParkGreenSqM + summary2000_NDVI85th_w$VacGreenSqM + summary2000_NDVI85th_w$OtherGreenSqM
#90th
summary2000_NDVI90th_w$GreenSqM = summary2000_NDVI90th_w$ParkGreenSqM + summary2000_NDVI90th_w$VacGreenSqM + summary2000_NDVI90th_w$OtherGreenSqM

##2010
#70th
summary2010_NDVI70th_w$GreenSqM = summary2010_NDVI70th_w$ParkGreenSqM + summary2010_NDVI70th_w$VacGreenSqM + summary2010_NDVI70th_w$OtherGreenSqM
#75th
summary2010_NDVI75th_w$GreenSqM = summary2010_NDVI75th_w$ParkGreenSqM + summary2010_NDVI75th_w$VacGreenSqM + summary2010_NDVI75th_w$OtherGreenSqM
#80th
summary2010_NDVI80th_w$GreenSqM = summary2010_NDVI80th_w$ParkGreenSqM + summary2010_NDVI80th_w$VacGreenSqM + summary2010_NDVI80th_w$OtherGreenSqM
#85th
summary2010_NDVI85th_w$GreenSqM = summary2010_NDVI85th_w$ParkGreenSqM + summary2010_NDVI85th_w$VacGreenSqM + summary2010_NDVI85th_w$OtherGreenSqM
#90th
summary2010_NDVI90th_w$GreenSqM = summary2010_NDVI90th_w$ParkGreenSqM + summary2010_NDVI90th_w$VacGreenSqM + summary2010_NDVI90th_w$OtherGreenSqM

##2015
#70th
summary2015_NDVI70th_w$GreenSqM = summary2015_NDVI70th_w$ParkGreenSqM + summary2015_NDVI70th_w$VacGreenSqM + summary2015_NDVI70th_w$OtherGreenSqM
#75th
summary2015_NDVI75th_w$GreenSqM = summary2015_NDVI75th_w$ParkGreenSqM + summary2015_NDVI75th_w$VacGreenSqM + summary2015_NDVI75th_w$OtherGreenSqM
#80th
summary2015_NDVI80th_w$GreenSqM = summary2015_NDVI80th_w$ParkGreenSqM + summary2015_NDVI80th_w$VacGreenSqM + summary2015_NDVI80th_w$OtherGreenSqM
#85th
summary2015_NDVI85th_w$GreenSqM = summary2015_NDVI85th_w$ParkGreenSqM + summary2015_NDVI85th_w$VacGreenSqM + summary2015_NDVI85th_w$OtherGreenSqM
#90th
summary2015_NDVI90th_w$GreenSqM = summary2015_NDVI90th_w$ParkGreenSqM + summary2015_NDVI90th_w$VacGreenSqM + summary2015_NDVI90th_w$OtherGreenSqM

#G. Merge with census data
##1990
#70th
MT_1990_G70th = merge(MT_1990,summary1990_NDVI70th_w,by=c("cluster_id"),all.x=TRUE)
#75th
MT_1990_G75th = merge(MT_1990,summary1990_NDVI75th_w,by=c("cluster_id"),all.x=TRUE)
#80th
MT_1990_G80th = merge(MT_1990,summary1990_NDVI80th_w,by=c("cluster_id"),all.x=TRUE)
#85th
MT_1990_G85th = merge(MT_1990,summary1990_NDVI85th_w,by=c("cluster_id"),all.x=TRUE)
#90th
MT_1990_G90th = merge(MT_1990,summary1990_NDVI90th_w,by=c("cluster_id"),all.x=TRUE)

##2000
#70th
MT_2000_G70th = merge(MT_2000,summary2000_NDVI70th_w,by=c("cluster_id"),all.x=TRUE)
#75th
MT_2000_G75th = merge(MT_2000,summary2000_NDVI75th_w,by=c("cluster_id"),all.x=TRUE)
#80th
MT_2000_G80th = merge(MT_2000,summary2000_NDVI80th_w,by=c("cluster_id"),all.x=TRUE)
#85th
MT_2000_G85th = merge(MT_2000,summary2000_NDVI85th_w,by=c("cluster_id"),all.x=TRUE)
#90th
MT_2000_G90th = merge(MT_2000,summary2000_NDVI90th_w,by=c("cluster_id"),all.x=TRUE)

##2010
#70th
MT_2010_G70th = merge(MT_2010,summary2010_NDVI70th_w,by=c("cluster_id"),all.x=TRUE)
#75th
MT_2010_G75th = merge(MT_2010,summary2010_NDVI75th_w,by=c("cluster_id"),all.x=TRUE)
#80th
MT_2010_G80th = merge(MT_2010,summary2010_NDVI80th_w,by=c("cluster_id"),all.x=TRUE)
#85th
MT_2010_G85th = merge(MT_2010,summary2010_NDVI85th_w,by=c("cluster_id"),all.x=TRUE)
#90th
MT_2010_G90th = merge(MT_2010,summary2010_NDVI90th_w,by=c("cluster_id"),all.x=TRUE)

##2015
#70th
MT_2015_G70th = merge(MT_2015,summary2015_NDVI70th_w,by=c("cluster_id"),all.x=TRUE)
#75th
MT_2015_G75th = merge(MT_2015,summary2015_NDVI75th_w,by=c("cluster_id"),all.x=TRUE)
#80th
MT_2015_G80th = merge(MT_2015,summary2015_NDVI80th_w,by=c("cluster_id"),all.x=TRUE)
#85th
MT_2015_G85th = merge(MT_2015,summary2015_NDVI85th_w,by=c("cluster_id"),all.x=TRUE)
#90th
MT_2015_G90th = merge(MT_2015,summary2015_NDVI90th_w,by=c("cluster_id"),all.x=TRUE)

#H. Calculate greenspace variables
### pctA_G = % of census tract covered by any type of greenspace (including the excluded class)
##1990
#70th
MT_1990_G70th$pctA_G = MT_1990_G70th$GreenSqM/MT_1990_G70th$areaSqM
#75th
MT_1990_G75th$pctA_G = MT_1990_G75th$GreenSqM/MT_1990_G75th$areaSqM
#80th
MT_1990_G80th$pctA_G = MT_1990_G80th$GreenSqM/MT_1990_G80th$areaSqM
#85th
MT_1990_G85th$pctA_G = MT_1990_G85th$GreenSqM/MT_1990_G85th$areaSqM
#90th
MT_1990_G90th$pctA_G = MT_1990_G90th$GreenSqM/MT_1990_G90th$areaSqM

##2000
#70th
MT_2000_G70th$pctA_G = MT_2000_G70th$GreenSqM/MT_2000_G70th$areaSqM
#75th
MT_2000_G75th$pctA_G = MT_2000_G75th$GreenSqM/MT_2000_G75th$areaSqM
#80th
MT_2000_G80th$pctA_G = MT_2000_G80th$GreenSqM/MT_2000_G80th$areaSqM
#85th
MT_2000_G85th$pctA_G = MT_2000_G85th$GreenSqM/MT_2000_G85th$areaSqM
#90th
MT_2000_G90th$pctA_G = MT_2000_G90th$GreenSqM/MT_2000_G90th$areaSqM

##2010
#70th
MT_2010_G70th$pctA_G = MT_2010_G70th$GreenSqM/MT_2010_G70th$areaSqM
#75th
MT_2010_G75th$pctA_G = MT_2010_G75th$GreenSqM/MT_2010_G75th$areaSqM
#80th
MT_2010_G80th$pctA_G = MT_2010_G80th$GreenSqM/MT_2010_G80th$areaSqM
#85th
MT_2010_G85th$pctA_G = MT_2010_G85th$GreenSqM/MT_2010_G85th$areaSqM
#90th
MT_2010_G90th$pctA_G = MT_2010_G90th$GreenSqM/MT_2010_G90th$areaSqM

##2015
#70th
MT_2015_G70th$pctA_G = MT_2015_G70th$GreenSqM/MT_2015_G70th$areaSqM
#75th
MT_2015_G75th$pctA_G = MT_2015_G75th$GreenSqM/MT_2015_G75th$areaSqM
#80th
MT_2015_G80th$pctA_G = MT_2015_G80th$GreenSqM/MT_2015_G80th$areaSqM
#85th
MT_2015_G85th$pctA_G = MT_2015_G85th$GreenSqM/MT_2015_G85th$areaSqM
#90th
MT_2015_G90th$pctA_G = MT_2015_G90th$GreenSqM/MT_2015_G90th$areaSqM

### pctA_parkG = % of census tract covered by park greenspace
##1990
#70th
MT_1990_G70th$pctA_parkG = MT_1990_G70th$ParkGreenSqM/MT_1990_G70th$areaSqM
#75th
MT_1990_G75th$pctA_parkG = MT_1990_G75th$ParkGreenSqM/MT_1990_G75th$areaSqM
#80th
MT_1990_G80th$pctA_parkG = MT_1990_G80th$ParkGreenSqM/MT_1990_G80th$areaSqM
#85th
MT_1990_G85th$pctA_parkG = MT_1990_G85th$ParkGreenSqM/MT_1990_G85th$areaSqM
#90th
MT_1990_G90th$pctA_parkG = MT_1990_G90th$ParkGreenSqM/MT_1990_G90th$areaSqM

##2000
#70th
MT_2000_G70th$pctA_parkG = MT_2000_G70th$ParkGreenSqM/MT_2000_G70th$areaSqM
#75th
MT_2000_G75th$pctA_parkG = MT_2000_G75th$ParkGreenSqM/MT_2000_G75th$areaSqM
#80th
MT_2000_G80th$pctA_parkG = MT_2000_G80th$ParkGreenSqM/MT_2000_G80th$areaSqM
#85th
MT_2000_G85th$pctA_parkG = MT_2000_G85th$ParkGreenSqM/MT_2000_G85th$areaSqM
#90th
MT_2000_G90th$pctA_parkG = MT_2000_G90th$ParkGreenSqM/MT_2000_G90th$areaSqM

##2010
#70th
MT_2010_G70th$pctA_parkG = MT_2010_G70th$ParkGreenSqM/MT_2010_G70th$areaSqM
#75th
MT_2010_G75th$pctA_parkG = MT_2010_G75th$ParkGreenSqM/MT_2010_G75th$areaSqM
#80th
MT_2010_G80th$pctA_parkG = MT_2010_G80th$ParkGreenSqM/MT_2010_G80th$areaSqM
#85th
MT_2010_G85th$pctA_parkG = MT_2010_G85th$ParkGreenSqM/MT_2010_G85th$areaSqM
#90th
MT_2010_G90th$pctA_parkG = MT_2010_G90th$ParkGreenSqM/MT_2010_G90th$areaSqM

##2015
#70th
MT_2015_G70th$pctA_parkG = MT_2015_G70th$ParkGreenSqM/MT_2015_G70th$areaSqM
#75th
MT_2015_G75th$pctA_parkG = MT_2015_G75th$ParkGreenSqM/MT_2015_G75th$areaSqM
#80th
MT_2015_G80th$pctA_parkG = MT_2015_G80th$ParkGreenSqM/MT_2015_G80th$areaSqM
#85th
MT_2015_G85th$pctA_parkG = MT_2015_G85th$ParkGreenSqM/MT_2015_G85th$areaSqM
#90th
MT_2015_G90th$pctA_parkG = MT_2015_G90th$ParkGreenSqM/MT_2015_G90th$areaSqM

### pctA_vacG = % of census tract covered by greenspace on vacant land
##1990
#70th
MT_1990_G70th$pctA_vacG = MT_1990_G70th$VacGreenSqM/MT_1990_G70th$areaSqM 
#75th
MT_1990_G75th$pctA_vacG = MT_1990_G75th$VacGreenSqM/MT_1990_G75th$areaSqM 
#80th
MT_1990_G80th$pctA_vacG = MT_1990_G80th$VacGreenSqM/MT_1990_G80th$areaSqM 
#85th
MT_1990_G85th$pctA_vacG = MT_1990_G85th$VacGreenSqM/MT_1990_G85th$areaSqM 
#90th
MT_1990_G90th$pctA_vacG = MT_1990_G90th$VacGreenSqM/MT_1990_G90th$areaSqM

##2000
#70th
MT_2000_G70th$pctA_vacG = MT_2000_G70th$VacGreenSqM/MT_2000_G70th$areaSqM 
#75th
MT_2000_G75th$pctA_vacG = MT_2000_G75th$VacGreenSqM/MT_2000_G75th$areaSqM 
#80th
MT_2000_G80th$pctA_vacG = MT_2000_G80th$VacGreenSqM/MT_2000_G80th$areaSqM 
#85th
MT_2000_G85th$pctA_vacG = MT_2000_G85th$VacGreenSqM/MT_2000_G85th$areaSqM 
#90th
MT_2000_G90th$pctA_vacG = MT_2000_G90th$VacGreenSqM/MT_2000_G90th$areaSqM

##2010
#70th
MT_2010_G70th$pctA_vacG = MT_2010_G70th$VacGreenSqM/MT_2010_G70th$areaSqM 
#75th
MT_2010_G75th$pctA_vacG = MT_2010_G75th$VacGreenSqM/MT_2010_G75th$areaSqM 
#80th
MT_2010_G80th$pctA_vacG = MT_2010_G80th$VacGreenSqM/MT_2010_G80th$areaSqM 
#85th
MT_2010_G85th$pctA_vacG = MT_2010_G85th$VacGreenSqM/MT_2010_G85th$areaSqM 
#90th
MT_2010_G90th$pctA_vacG = MT_2010_G90th$VacGreenSqM/MT_2010_G90th$areaSqM

##2015
#70th
MT_2015_G70th$pctA_vacG = MT_2015_G70th$VacGreenSqM/MT_2015_G70th$areaSqM 
#75th
MT_2015_G75th$pctA_vacG = MT_2015_G75th$VacGreenSqM/MT_2015_G75th$areaSqM 
#80th
MT_2015_G80th$pctA_vacG = MT_2015_G80th$VacGreenSqM/MT_2015_G80th$areaSqM 
#85th
MT_2015_G85th$pctA_vacG = MT_2015_G85th$VacGreenSqM/MT_2015_G85th$areaSqM 
#90th
MT_2015_G90th$pctA_vacG = MT_2015_G90th$VacGreenSqM/MT_2015_G90th$areaSqM

### pctA_othG = % of census tract covered by all other greenspace
##1990
#70th
MT_1990_G70th$pctA_othG = MT_1990_G70th$OtherGreenSqM/MT_1990_G70th$areaSqM 
#75th
MT_1990_G75th$pctA_othG = MT_1990_G75th$OtherGreenSqM/MT_1990_G75th$areaSqM 
#80th
MT_1990_G80th$pctA_othG = MT_1990_G80th$OtherGreenSqM/MT_1990_G80th$areaSqM 
#85th
MT_1990_G85th$pctA_othG = MT_1990_G85th$OtherGreenSqM/MT_1990_G85th$areaSqM 
#90th
MT_1990_G90th$pctA_othG = MT_1990_G90th$OtherGreenSqM/MT_1990_G90th$areaSqM 

##2000
#70th
MT_2000_G70th$pctA_othG = MT_2000_G70th$OtherGreenSqM/MT_2000_G70th$areaSqM 
#75th
MT_2000_G75th$pctA_othG = MT_2000_G75th$OtherGreenSqM/MT_2000_G75th$areaSqM 
#80th
MT_2000_G80th$pctA_othG = MT_2000_G80th$OtherGreenSqM/MT_2000_G80th$areaSqM 
#85th
MT_2000_G85th$pctA_othG = MT_2000_G85th$OtherGreenSqM/MT_2000_G85th$areaSqM 
#90th
MT_2000_G90th$pctA_othG = MT_2000_G90th$OtherGreenSqM/MT_2000_G90th$areaSqM

##2010
#70th
MT_2010_G70th$pctA_othG = MT_2010_G70th$OtherGreenSqM/MT_2010_G70th$areaSqM 
#75th
MT_2010_G75th$pctA_othG = MT_2010_G75th$OtherGreenSqM/MT_2010_G75th$areaSqM 
#80th
MT_2010_G80th$pctA_othG = MT_2010_G80th$OtherGreenSqM/MT_2010_G80th$areaSqM 
#85th
MT_2010_G85th$pctA_othG = MT_2010_G85th$OtherGreenSqM/MT_2010_G85th$areaSqM 
#90th
MT_2010_G90th$pctA_othG = MT_2010_G90th$OtherGreenSqM/MT_2010_G90th$areaSqM

##2015
#70th
MT_2015_G70th$pctA_othG = MT_2015_G70th$OtherGreenSqM/MT_2015_G70th$areaSqM 
#75th
MT_2015_G75th$pctA_othG = MT_2015_G75th$OtherGreenSqM/MT_2015_G75th$areaSqM 
#80th
MT_2015_G80th$pctA_othG = MT_2015_G80th$OtherGreenSqM/MT_2015_G80th$areaSqM 
#85th
MT_2015_G85th$pctA_othG = MT_2015_G85th$OtherGreenSqM/MT_2015_G85th$areaSqM 
#90th
MT_2015_G90th$pctA_othG = MT_2015_G90th$OtherGreenSqM/MT_2015_G90th$areaSqM

###Add Year column
MT_1990_G70th$Year = 1990 
MT_1990_G75th$Year = 1990 
MT_1990_G80th$Year = 1990
MT_1990_G85th$Year = 1990
MT_1990_G90th$Year = 1990

MT_2000_G70th$Year = 2000 
MT_2000_G75th$Year = 2000 
MT_2000_G80th$Year = 2000
MT_2000_G85th$Year = 2000
MT_2000_G90th$Year = 2000

MT_2010_G70th$Year = 2010 
MT_2010_G75th$Year = 2010 
MT_2010_G80th$Year = 2010
MT_2010_G85th$Year = 2010
MT_2010_G90th$Year = 2010

MT_2015_G70th$Year = 2015 
MT_2015_G75th$Year = 2015 
MT_2015_G80th$Year = 2015
MT_2015_G85th$Year = 2015
MT_2015_G90th$Year = 2015

#J. Combine each year
ndvi70th = rbind(MT_1990_G70th@data,MT_2000_G70th@data,MT_2010_G70th@data,MT_2015_G70th@data)
ndvi75th = rbind(MT_1990_G75th@data,MT_2000_G75th@data,MT_2010_G75th@data,MT_2015_G75th@data)
ndvi80th = rbind(MT_1990_G80th@data,MT_2000_G80th@data,MT_2010_G80th@data,MT_2015_G80th@data)
ndvi85th = rbind(MT_1990_G85th@data,MT_2000_G85th@data,MT_2010_G85th@data,MT_2015_G85th@data)
ndvi90th = rbind(MT_1990_G90th@data,MT_2000_G90th@data,MT_2010_G90th@data,MT_2015_G90th@data)

#I. Keep only final variables
keep = c('cluster_id','Year','areaSqM','ParkGreenSqM','VacGreenSqM','OtherGreenSqM','GreenSqM','pctA_G','pctA_parkG','pctA_vacG','pctA_othG')
ndvi70th = ndvi70th[keep]
ndvi75th = ndvi75th[keep]
ndvi80th = ndvi80th[keep]
ndvi85th = ndvi85th[keep]
ndvi90th = ndvi90th[keep]

#J. Replace NA values with 0 (otherwise summing in the next step won't work)
ndvi70th[is.na(ndvi70th)] = 0 
ndvi75th[is.na(ndvi75th)] = 0 
ndvi80th[is.na(ndvi80th)] = 0 
ndvi85th[is.na(ndvi85th)] = 0
ndvi90th[is.na(ndvi90th)] = 0

# STEP 3 -----------------------------------------------
#Plot % greenspace for each threshold by year (all LU groupings)

#Summarize greenspace values by year
summary_ndvi70th = ndvi70th %>%
  group_by(Year) %>%
  summarise(SqM = sum(areaSqM), GreenSqM = sum(GreenSqM), ParkGreenSqM = sum(ParkGreenSqM), VacGreenSqM = sum(VacGreenSqM),
            OtherGreenSqM = sum(OtherGreenSqM))

summary_ndvi75th = ndvi75th %>%
  group_by(Year) %>%
  summarise(SqM = sum(areaSqM), GreenSqM = sum(GreenSqM), ParkGreenSqM = sum(ParkGreenSqM), VacGreenSqM = sum(VacGreenSqM),
            OtherGreenSqM = sum(OtherGreenSqM))

summary_ndvi80th = ndvi80th %>%
  group_by(Year) %>%
  summarise(SqM = sum(areaSqM), GreenSqM = sum(GreenSqM), ParkGreenSqM = sum(ParkGreenSqM), VacGreenSqM = sum(VacGreenSqM),
            OtherGreenSqM = sum(OtherGreenSqM))

summary_ndvi85th = ndvi85th %>%
  group_by(Year) %>%
  summarise(SqM = sum(areaSqM), GreenSqM = sum(GreenSqM), ParkGreenSqM = sum(ParkGreenSqM), VacGreenSqM = sum(VacGreenSqM),
            OtherGreenSqM = sum(OtherGreenSqM))

summary_ndvi90th = ndvi90th %>%
  group_by(Year) %>%
  summarise(SqM = sum(areaSqM), GreenSqM = sum(GreenSqM), ParkGreenSqM = sum(ParkGreenSqM), VacGreenSqM = sum(VacGreenSqM),
            OtherGreenSqM = sum(OtherGreenSqM))

#Add column with threshold
summary_ndvi70th$Percentile = "70th"
summary_ndvi75th$Percentile = "75th"
summary_ndvi80th$Percentile = "80th"
summary_ndvi85th$Percentile = "85th"
summary_ndvi90th$Percentile = "90th"

#Combine threshold dfs
summary_ndvi = rbind(summary_ndvi70th,summary_ndvi75th,summary_ndvi80th,summary_ndvi85th,summary_ndvi90th)

#Plot by sum year and threshold
pGreenSqM = ggplot(data = summary_ndvi, aes(x = Year, y = GreenSqM, group = Percentile, color = Percentile)) +
  geom_line(size = 2)+
  ylab("Greenspace (m)")+
  scale_y_continuous(label=scientific_format(digits=2))+ 
  scale_color_brewer(palette = 'Greens',direction = -1)+
  theme(text=element_text(size = 15),
        legend.position='top', 
        legend.justification='left',
        legend.direction='horizontal')+
  ggtitle("Total Green Space")

pParkGreenSqM = ggplot(data = summary_ndvi, aes(x = Year, y = ParkGreenSqM, group = Percentile, color = Percentile)) +
  geom_line(size = 2)+
  scale_y_continuous(label=scientific_format(digits=2))+ 
  ylab("Greenspace (m)")+
  scale_color_brewer(palette = 'Greens',direction = -1)+
  theme(text=element_text(size = 15),
        legend.position='top', 
        legend.justification='left',
        legend.direction='horizontal')+
  ggtitle("Park Green Space")

pVacantGreenSqM = ggplot(data = summary_ndvi, aes(x = Year, y = VacGreenSqM, group = Percentile, color = Percentile)) +
  geom_line(size = 2)+
  scale_y_continuous(label=scientific_format(digits=2))+ 
  ylab("Greenspace (m)")+
  scale_color_brewer(palette = 'Greens',direction = -1)+
  theme(text=element_text(size = 15),
        legend.position='top', 
        legend.justification='left',
        legend.direction='horizontal')+
  ggtitle("Vacant Green Space")

pInfGreenSqM = ggplot(data = summary_ndvi, aes(x = Year, y = OtherGreenSqM, group = Percentile, color = Percentile)) +
  geom_line(size = 2)+
  scale_y_continuous(label=scientific_format(digits=2))+ 
  ylab("Greenspace (m)")+
  scale_color_brewer(palette = 'Greens',direction = -1)+
  theme()+
  theme(text=element_text(size = 15),
        legend.position='top', 
        legend.justification='left',
        legend.direction='horizontal') +
  ggtitle("All Other Green Space")

#Plot the three used in the paper together:
grid.arrange(pGreenSqM,pParkGreenSqM,pVacantGreenSqM,pInfGreenSqM,ncol=2) #change to rows not columns

# STEP 4 -----------------------------------------------
#Calculate the smoothness of the trend

#Add column with threshold
ndvi70th$Percentile = "70th"
ndvi75th$Percentile = "75th"
ndvi80th$Percentile = "80th"
ndvi85th$Percentile = "85th"
ndvi90th$Percentile = "90th"

#Combine
ndviPanel = rbind(ndvi70th,ndvi75th,ndvi80th,ndvi85th,ndvi90th)

#Define informal greenspace variables
ndviPanel$InfGreenSqM = ndviPanel$OtherGreenSqM

ndviPanel$pctA_infG = ndviPanel$InfGreenSqM/ndviPanel$areaSqM #InfGreenSqM/SqM

# #Calculate the standard deviation & variance
# grouped = group_by(ndviPanel, Year,Percentile)
# SD_DF = summarise(grouped, GreenSqM_mean = mean(GreenSqM), GreenSqM_sd = sd(GreenSqM), GreenSqM_var = var(GreenSqM),
#                   ParkGreenSqM_mean = mean(ParkGreenSqM), ParkGreenSqM_sd = sd(ParkGreenSqM), ParkGreenSqM_var = var(ParkGreenSqM),
#                   InfGreenSqM_mean = mean(InfGreenSqM), InfGreenSqM_sd = sd(InfGreenSqM), InfGreenSqM_var = var(InfGreenSqM),
#                   pctA_G_mean = mean(pctA_G), pctA_G_sd = sd(pctA_G), pctA_G_var = var(pctA_G),
#                   pctA_parkG_mean = mean(pctA_parkG), pctA_parkG_sd = sd(pctA_parkG), pctA_parkG_var = var(pctA_parkG),
#                   pctA_infG_mean = mean(pctA_infG), pctA_infG_sd = sd(pctA_infG), pctA_infG_var = var(pctA_infG))

#Calculate sm and ac
#sm - Calculate scale-independent measure of smoothness (small number = smoother series)
#ac - Calculate lag-one autocorrelation (1 = smooth trend, 0 = random, -1 = jagged trend)
#Source: https://stats.stackexchange.com/questions/24607/how-to-measure-smoothness-of-a-time-series-in-r
grouped2 = group_by(ndviPanel, cluster_id,Percentile)
LAG_DF = summarise(grouped2, 
                   GreenSqM_sm = sd(diff(GreenSqM))/abs(mean(diff(GreenSqM))),
                   ParkGreenSqM_sm = sd(diff(ParkGreenSqM))/abs(mean(diff(ParkGreenSqM))),
                   InfGreenSqM_sm = sd(diff(InfGreenSqM))/abs(mean(diff(InfGreenSqM))),
                   VacGreenSqM_sm = sd(diff(VacGreenSqM))/abs(mean(diff(VacGreenSqM))),
                   pctA_G_sm = sd(diff(pctA_G))/abs(mean(diff(pctA_G))),
                   pctA_parkG_sm = sd(diff(pctA_parkG))/abs(mean(diff(pctA_parkG))),
                   pctA_infG_sm = sd(diff(pctA_infG))/abs(mean(diff(pctA_infG))),
                   pctA_vacG_sm = sd(diff(pctA_vacG))/abs(mean(diff(pctA_vacG))),
                   #ac
                   #GreenSqM_ac = cor(GreenSqM[-length(GreenSqM)],GreenSqM[-1]),
                   #ParkGreenSqM_ac = cor(ParkGreenSqM[-length(ParkGreenSqM)],ParkGreenSqM[-1]),
                   #InfGreenSqM_ac = cor(InfGreenSqM[-length(InfGreenSqM)],InfGreenSqM[-1]),
                   #pctA_G_ac = cor(pctA_G[-length(pctA_G)],pctA_G[-1]),
                   #pctA_parkG_ac = cor(pctA_parkG[-length(pctA_parkG)],pctA_parkG[-1]),
                   #pctA_infG_ac = cor(pctA_infG[-length(pctA_infG)],pctA_infG[-1])
                   ) #Get lots of NAs and Inf for sm because of the census tracts with no greenspace

#Average the year-over-year smoothness by census tract
summary_sm = LAG_DF %>%
  group_by(Percentile) %>%
  summarise(#GreenSqM_avgSm = mean(GreenSqM_sm[is.finite(GreenSqM_sm)]),
            #ParkGreenSqM_avgSm = mean(ParkGreenSqM_sm[is.finite(ParkGreenSqM_sm)]),
            #VacGreenSqM_avgSm = mean(VacGreenSqM_sm[is.finite(VacGreenSqM_sm)]),
            #InfGreenSqM_avgSm = mean(InfGreenSqM_sm[is.finite(InfGreenSqM_sm)]),
            pctA_G_avgSm = mean(pctA_G_sm[is.finite(pctA_G_sm)]),
            pctA_parkG_avgSm = mean(pctA_parkG_sm[is.finite(pctA_parkG_sm)]),
            pctA_vacG_avgSm = mean(pctA_vacG_sm[is.finite(pctA_vacG_sm)]),
            pctA_infG_avgSm = mean(pctA_infG_sm[is.finite(pctA_infG_sm)])
            
            #GreenSqM_avgAc = mean(GreenSqM_ac[is.finite(GreenSqM_ac)]),
            #ParkGreenSqM_avgAc = mean(ParkGreenSqM_ac[is.finite(ParkGreenSqM_ac)]),
            #InfGreenSqM_avgAc = mean(InfGreenSqM_ac[is.finite(InfGreenSqM_ac)]),
            #pctA_G_avgAc = mean(pctA_G_ac[is.finite(pctA_G_ac)]),
            #pctA_parkG_avgAc = mean(pctA_parkG_ac[is.finite(pctA_parkG_ac)]),
            #pctA_infG_avgAc = mean(pctA_infG_ac[is.finite(pctA_infG_ac)])
            )
